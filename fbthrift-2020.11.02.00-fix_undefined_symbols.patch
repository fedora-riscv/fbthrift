From 1e3c68e045ee06c4209d3f9d90e162b67f7c9542 Mon Sep 17 00:00:00 2001
From: Michel Alexandre Salim <michel@michel-slm.name>
Date: Wed, 4 Nov 2020 11:44:35 -0800
Subject: [PATCH] Fix undefined-non-weak-symbol warnings

Signed-off-by: Michel Alexandre Salim <michel@michel-slm.name>
---
 thrift/compiler/CMakeLists.txt | 4 +++-
 thrift/lib/cpp2/CMakeLists.txt | 9 +++++++++
 2 files changed, 12 insertions(+), 1 deletion(-)

diff --git a/thrift/compiler/CMakeLists.txt b/thrift/compiler/CMakeLists.txt
index 1ab985ac6..a82ea06d0 100644
--- a/thrift/compiler/CMakeLists.txt
+++ b/thrift/compiler/CMakeLists.txt
@@ -40,6 +40,7 @@ add_library(
   ast/t_typedef.cc
   ast/base_types.cc
   ast/t_scope.cc
+  ast/visitor.cc
 )
 target_link_libraries(compiler_ast ${OPENSSL_LIBRARIES})
 
@@ -115,10 +116,12 @@ add_library(
 
   ${GENERATOR_FILES}
   $<TARGET_OBJECTS:compiler_generate_templates>
+  validator/validator.cc
 )
 target_link_libraries(
   compiler_generators
 
+  compiler_ast
   compiler_base
   compiler_lib
   mustache_lib
@@ -142,7 +145,6 @@ add_executable(
   compiler.cc
   mutator/mutator.cc
   validator/diagnostic.cc
-  validator/validator.cc
   ast/visitor.cc
 )
 target_link_libraries(
diff --git a/thrift/lib/cpp2/CMakeLists.txt b/thrift/lib/cpp2/CMakeLists.txt
index e6a4673af..1e757f5c6 100644
--- a/thrift/lib/cpp2/CMakeLists.txt
+++ b/thrift/lib/cpp2/CMakeLists.txt
@@ -34,6 +34,10 @@ add_library(
   thriftmetadata
 
   ${metadata-cpp2-SOURCES}
+  gen/module_types_cpp.cpp
+  protocol/CompactProtocol.cpp # can't link against thriftprotocol, dep cycle
+  ../cpp/protocol/TProtocolException.cpp
+  ../cpp/util/VarintUtils.cpp
 )
 add_dependencies(thriftmetadata metadata-cpp2-target)
 target_link_libraries(
@@ -57,6 +61,7 @@ target_link_libraries(
   PUBLIC
     Folly::folly
     thriftmetadata
+    thriftprotocol
     ${GLOG_LIBRARIES}
     ${LIBGFLAGS_LIBRARY}
 )
@@ -67,6 +72,9 @@ add_library(
 
   ${RpcMetadata-cpp2-SOURCES}
   gen/module_types_cpp.cpp
+  protocol/CompactProtocol.cpp # can't link against thriftprotocol, dep cycle
+  ../cpp/protocol/TProtocolException.cpp
+  ../cpp/util/VarintUtils.cpp
 )
 add_dependencies(rpcmetadata RpcMetadata-cpp2-target)
 target_link_libraries(
@@ -93,6 +101,7 @@ add_library(
   ../cpp/protocol/TBase64Utils.cpp
   ../cpp/protocol/TProtocolException.cpp
   ../cpp/protocol/TSimpleJSONProtocol.cpp
+  ../cpp/util/VarintUtils.cpp
   ${reflection-cpp2-SOURCES}
 )
 add_dependencies(thriftprotocol reflection-cpp2-target)
-- 
2.28.0

